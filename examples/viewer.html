<!DOCTYPE html>
<html>
<head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
        <title>Viewer Example</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <style>
                :root {
                        color-scheme: light;
                        font-family: "Helvetica Neue", "Lucida Grande", "Segoe UI", Arial, sans-serif;
                        font-size: 16px;
                }

                *, *::before, *::after {
                        box-sizing: border-box;
                }

                body {
                        margin: 0;
                        min-height: 100vh;
                        background:
                                linear-gradient(180deg, #fbfcff 0%, #eef2ff 60%, #e1e7ff 100%),
                                repeating-linear-gradient(-45deg, rgba(160, 174, 192, 0.08) 0px, rgba(160, 174, 192, 0.08) 4px,
                                                rgba(255, 255, 255, 0.08) 4px, rgba(255, 255, 255, 0.08) 8px);
                        color: #27304a;
                        line-height: 1.6;
                        -webkit-font-smoothing: antialiased;
                        text-rendering: optimizeLegibility;
                }

                #pano {
                        position: fixed;
                        inset: 0;
                        z-index: 0;
                }

                .control-panel {
                        position: fixed;
                        top: 24px;
                        left: 24px;
                        width: min(420px, calc(100% - 48px));
                        max-height: calc(100vh - 48px);
                        padding: 1.5rem;
                        display: flex;
                        flex-direction: column;
                        gap: 1.25rem;
                        border-radius: 14px;
                        background:
                                linear-gradient(180deg, #ffffff 0%, #f3f6ff 100%),
                                radial-gradient(120% 120% at 0% 0%, rgba(255, 255, 255, 0.6) 0%, rgba(243, 247, 255, 0) 70%);
                        border: 1px solid #c6d3f1;
                        box-shadow: 0 18px 42px rgba(62, 86, 170, 0.24), inset 0 1px 0 rgba(255, 255, 255, 0.65);
                        overflow-y: auto;
                        z-index: 10;
                        transition: opacity 0.25s ease, transform 0.25s ease;
                }

                .control-panel.is-hidden {
                        opacity: 0;
                        pointer-events: none;
                        transform: translateY(-8px);
                }

                .panel-header {
                        padding-bottom: 1rem;
                        border-bottom: 1px solid #d6dcf7;
                        position: relative;
                }

                .panel-header::after {
                        content: "";
                        position: absolute;
                        left: 0;
                        right: 0;
                        bottom: -1px;
                        height: 1px;
                        background: linear-gradient(90deg, rgba(158, 175, 232, 0) 0%, rgba(158, 175, 232, 0.7) 50%, rgba(158, 175, 232, 0) 100%);
                }

                .panel-header h1 {
                        margin: 0;
                        font-size: 1.5rem;
                        font-weight: 700;
                        letter-spacing: -0.01em;
                        color: #1c2642;
                        text-shadow: 0 1px 0 rgba(255, 255, 255, 0.8);
                }

                .panel-subtitle {
                        margin: 0.3rem 0 0;
                        font-size: 0.95rem;
                        color: #53618c;
                }

                .search-form {
                        display: flex;
                        gap: 0.5rem;
                        align-items: center;
                }

                .search-form input[type="text"] {
                        flex: 1 1 auto;
                        padding: 0.65rem 0.85rem;
                        border-radius: 10px;
                        border: 1px solid #c4cfef;
                        background: linear-gradient(180deg, #f9fbff 0%, #eef2ff 100%);
                        color: #27304a;
                        font-size: 0.95rem;
                        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
                        transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
                }

                .search-form input[type="text"]:focus {
                        outline: none;
                        border-color: #7a8eea;
                        box-shadow: 0 0 0 3px rgba(122, 142, 234, 0.25);
                        background: #ffffff;
                }

                .primary-button,
                .ghost-button,
                .control-button {
                        font: inherit;
                        border: none;
                        cursor: pointer;
                        border-radius: 999px;
                        padding: 0.6rem 1.1rem;
                        transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease;
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        gap: 0.35rem;
                        text-shadow: 0 1px 0 rgba(255, 255, 255, 0.65);
                }

                .primary-button {
                        background: linear-gradient(180deg, #7f98ff 0%, #5c74f1 100%);
                        color: #ffffff;
                        font-weight: 600;
                        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6), 0 12px 24px rgba(92, 116, 241, 0.32);
                }

                .primary-button:hover {
                        transform: translateY(-1px);
                        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7), 0 16px 30px rgba(92, 116, 241, 0.36);
                        background: linear-gradient(180deg, #889fff 0%, #6179f3 100%);
                }

                .ghost-button {
                        background: linear-gradient(180deg, #f9fbff 0%, #e9eeff 100%);
                        border: 1px solid #b7c4e6;
                        color: #3b4f7a;
                        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
                }

                .ghost-button:hover {
                        background: linear-gradient(180deg, #ffffff 0%, #eef2ff 100%);
                }

                .ghost-button--inline {
                        padding-inline: 0.85rem;
                        font-size: 0.85rem;
                }

                .control-button {
                        flex: 1 1 auto;
                        background: linear-gradient(180deg, #e7ecff 0%, #d4dcff 100%);
                        color: #2d3f6f;
                        font-weight: 600;
                        border: 1px solid #b6c3ef;
                        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
                }

                .control-button.is-active {
                        background: linear-gradient(180deg, #d3dcff 0%, #c1ccff 100%);
                        border-color: #8393e4;
                        color: #1f2a44;
                        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.9), 0 0 0 1px rgba(131, 147, 228, 0.2);
                }

                button:focus-visible {
                        outline: 3px solid rgba(122, 142, 234, 0.55);
                        outline-offset: 2px;
                }

                .map-wrapper {
                        border-radius: 14px;
                        overflow: hidden;
                        border: 1px solid #cad4f5;
                        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.7);
                }

                #map {
                        width: 100%;
                        height: 260px;
                }

                .control-row {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 0.5rem;
                        align-items: center;
                }

                .control-row--compact {
                        gap: 0.5rem;
                }

                .control-row--compact .control-button {
                        min-width: 0;
                        padding-inline: 0.85rem;
                        font-size: 0.9rem;
                }

                .progress {
                        position: relative;
                        width: 100%;
                        height: 10px;
                        border-radius: 999px;
                        background: #d7dff8;
                        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
                        overflow: hidden;
                }

                .progress__fill {
                        position: absolute;
                        inset: 0;
                        width: 0%;
                        background: linear-gradient(90deg, #8099ff 0%, #5e7af1 100%);
                        transition: width 0.2s ease;
                }

                .status-list {
                        margin: 0;
                        display: grid;
                        gap: 0.75rem;
                        font-size: 0.9rem;
                }

                .status-list__item {
                        display: grid;
                        gap: 0.3rem;
                }

                .status-list dt {
                        font-weight: 600;
                        color: #3f4f7c;
                }

                .status-list dd {
                        margin: 0;
                        color: #566692;
                }

                .route-primary {
                        font-weight: 600;
                        color: #36497a;
                }

                .route-secondary {
                        font-size: 0.85rem;
                        color: #6f7ea7;
                }

                kbd {
                        padding: 0.2rem 0.45rem;
                        border-radius: 6px;
                        border: 1px solid #c1caea;
                        background: linear-gradient(180deg, #f7f9ff 0%, #e9eeff 100%);
                        font-size: 0.8rem;
                        font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Consolas, monospace;
                        box-shadow: inset 0 -1px 0 rgba(209, 218, 248, 0.8), inset 0 1px 0 rgba(255, 255, 255, 0.8);
                        color: #364770;
                }

                .sr-only {
                        position: absolute;
                        width: 1px;
                        height: 1px;
                        padding: 0;
                        margin: -1px;
                        overflow: hidden;
                        clip: rect(0, 0, 0, 0);
                        border: 0;
                }

                @media (max-width: 840px) {
                        .control-panel {
                                width: min(460px, calc(100% - 32px));
                                left: 16px;
                                right: 16px;
                                top: 16px;
                                max-height: calc(100vh - 32px);
                        }

                        .search-form {
                                flex-direction: column;
                        }

                        .search-form input[type="text"],
                        .search-form button {
                                width: 100%;
                        }

                        .control-row {
                                flex-direction: column;
                                align-items: stretch;
                        }

                        .control-row--compact {
                                flex-direction: row;
                                flex-wrap: nowrap;
                                overflow: hidden;
                        }

                        .ghost-button--inline {
                                width: 100%;
                        }
                }

                @media (max-width: 560px) {
                        .control-panel {
                                width: calc(100% - 24px);
                                left: 12px;
                                right: 12px;
                                bottom: 12px;
                                top: auto;
                                max-height: 70vh;
                        }
                }
        </style>

        <script>
                (function() {
                        var STORAGE_KEY = 'hyperlapse-gmaps-key';
                        var googleMapsPromise;

                        function getStoredKey() {
                                try {
                                        return sessionStorage.getItem(STORAGE_KEY);
                                } catch (err) {
                                        return null;
                                }
                        }

                        function storeKey(key) {
                                try {
                                        sessionStorage.setItem(STORAGE_KEY, key);
                                } catch (err) {
                                        // ignore storage errors (private browsing, etc.)
                                }
                        }

                        function clearStoredKey() {
                                try {
                                        sessionStorage.removeItem(STORAGE_KEY);
                                } catch (err) {
                                        // ignore
                                }
                        }

                        function requestKey() {
                                var existing = getStoredKey();
                                if (existing) {
                                        return existing;
                                }

                                var apiKey = window.prompt('Enter your Google Maps API key to explore the Hyperlapse viewer.', '') || '';
                                apiKey = apiKey.trim();
                                if (!apiKey) {
                                        return null;
                                }

                                storeKey(apiKey);
                                return apiKey;
                        }

                        function loadGoogleMaps() {
                                if (googleMapsPromise) {
                                        return googleMapsPromise;
                                }

                                googleMapsPromise = new Promise(function(resolve, reject) {
                                        var apiKey = requestKey();
                                        if (!apiKey) {
                                                reject(new Error('A Google Maps API key is required to load the viewer demo.'));
                                                return;
                                        }

                                        var script = document.createElement('script');
                                        script.src = 'https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=geometry&key=' + encodeURIComponent(apiKey);
                                        script.async = true;

                                        script.onload = function() {
                                                resolve();
                                        };

                                        script.onerror = function() {
                                                clearStoredKey();
                                                reject(new Error('Failed to load the Google Maps API. Check your key and network connection.'));
                                        };

                                        document.head.appendChild(script);
                                });

                                googleMapsPromise.catch(function(error) {
                                        setTimeout(function() {
                                                alert(error.message);
                                        }, 0);
                                });

                                return googleMapsPromise;
                        }

                        window.whenGoogleMapsReady = function(onReady, onError) {
                                loadGoogleMaps().then(function() {
                                        if (typeof onReady === 'function') {
                                                onReady();
                                        }
                                }).catch(function(error) {
                                        if (typeof onError === 'function') {
                                                onError(error);
                                        }
                                });
                        };
                })();
        </script>
        <script src="https://cdn.jsdelivr.net/npm/dat.gui@0.7.9/build/dat.gui.min.js"></script>
        <script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
        <script src="js/GSVPano.js"></script>
        <script src="../src/Hyperlapse.js"></script>
        <script>
                var start_point;
                var end_point;
                var lookat_point;
                var map;
                var directions_renderer;
                var directions_service;
                var geocoder;
                var start_pin;
                var end_pin;
                var pivot_pin;
                var camera_pin;
                var _elevation = 0;
                var _route_markers = [];

                function show(msg) {
                        var status = document.getElementById('text');
                        if (status) {
                                status.innerHTML = msg;
                        }
                }

                window.whenGoogleMapsReady(function() {
                        function init() {
                                start_point = new google.maps.LatLng(44.3431, 6.783936);
                                end_point = new google.maps.LatLng(44.340578, 6.782684);
                                lookat_point = new google.maps.LatLng(44.34232747290594, 6.786460550292986);
                                _elevation = 0;
                                _route_markers = [];

                                if (window.location.hash) {
                                        var parts = window.location.hash.substr(1).split(',');
                                        if (parts.length >= 6) {
                                                start_point = new google.maps.LatLng(parts[0], parts[1]);
                                                lookat_point = new google.maps.LatLng(parts[2], parts[3]);
                                                end_point = new google.maps.LatLng(parts[4], parts[5]);
                                                _elevation = Number(parts[6]) || 0;
                                        }
                                }

                                function snapToRoad(point, callback) {
                                        var request = { origin: point, destination: point, travelMode: google.maps.TravelMode.DRIVING };
                                        directions_service.route(request, function(response, status) {
                                                if (status === google.maps.DirectionsStatus.OK && response.routes.length) {
                                                        callback(response.routes[0].overview_path[0]);
                                                } else {
                                                        callback(null);
                                                }
                                        });
                                }

                                function changeHash() {
                                        window.location.hash = [
                                                start_pin.getPosition().lat(),
                                                start_pin.getPosition().lng(),
                                                pivot_pin.getPosition().lat(),
                                                pivot_pin.getPosition().lng(),
                                                end_pin.getPosition().lat(),
                                                end_pin.getPosition().lng(),
                                                _elevation
                                        ].join(',');
                                }

                                var mapOpt = {
                                        mapTypeId: google.maps.MapTypeId.ROADMAP,
                                        center: start_point,
                                        zoom: 15
                                };

                                map = new google.maps.Map(document.getElementById('map'), mapOpt);
                                geocoder = new google.maps.Geocoder();

                                var overlay = new google.maps.StreetViewCoverageLayer();
                                overlay.setMap(map);

                                directions_service = new google.maps.DirectionsService();
                                directions_renderer = new google.maps.DirectionsRenderer({ draggable: false, markerOptions: { visible: false } });
                                directions_renderer.setMap(map);
                                directions_renderer.setOptions({ preserveViewport: true });

                                camera_pin = new google.maps.Marker({
                                        position: start_point,
                                        map: map
                                });

                                start_pin = new google.maps.Marker({
                                        position: start_point,
                                        draggable: true,
                                        map: map
                                });

                                google.maps.event.addListener(start_pin, 'dragend', function() {
                                        snapToRoad(start_pin.getPosition(), function(result) {
                                                if (!result) {
                                                        return;
                                                }
                                                start_pin.setPosition(result);
                                                start_point = result;
                                                changeHash();
                                        });
                                });

                                end_pin = new google.maps.Marker({
                                        position: end_point,
                                        draggable: true,
                                        map: map
                                });

                                google.maps.event.addListener(end_pin, 'dragend', function() {
                                        snapToRoad(end_pin.getPosition(), function(result) {
                                                if (!result) {
                                                        return;
                                                }
                                                end_pin.setPosition(result);
                                                end_point = result;
                                                changeHash();
                                        });
                                });

                                pivot_pin = new google.maps.Marker({
                                        position: lookat_point,
                                        draggable: true,
                                        map: map
                                });

                                google.maps.event.addListener(pivot_pin, 'dragend', function() {
                                        hyperlapse.setLookat(pivot_pin.getPosition());
                                        changeHash();
                                });

                                function findAddress(address) {
                                        if (!address) {
                                                return;
                                        }
                                        geocoder.geocode({ address: address }, function(results, status) {
                                                if (status === google.maps.GeocoderStatus.OK && results[0]) {
                                                        map.setCenter(results[0].geometry.location);
                                                        o.drop_pins();
                                                } else {
                                                        show('Geocode was not successful for the following reason: ' + status);
                                                }
                                        });
                                }

                                var search = document.getElementById('searchButton');
                                if (search) {
                                        search.addEventListener('click', function(event) {
                                                event.preventDefault();
                                                var value = document.getElementById('address');
                                                findAddress(value ? value.value : '');
                                        });
                                }

                                var mapForm = document.getElementById('mapForm');
                                if (mapForm) {
                                        mapForm.addEventListener('submit', function(event) {
                                                event.preventDefault();
                                                var value = document.getElementById('address');
                                                findAddress(value ? value.value : '');
                                        });
                                }

                                var pano = document.getElementById('pano');
                                var controlPanel = document.getElementById('controlPanel');
                                var playToggle = document.getElementById('playToggle');
                                var nextButton = document.getElementById('nextButton');
                                var prevButton = document.getElementById('prevButton');
                                var loadButton = document.getElementById('loadButton');
                                var generateButton = document.getElementById('generateButton');
                                var dropPinsButton = document.getElementById('dropPinsButton');
                                var progressBar = document.getElementById('progressBar');
                                var progressFill = document.getElementById('progressFill');
                                var routeDetails = document.getElementById('routeDetails');

                                if (!pano) {
                                        return;
                                }

                                var setRouteDetails = function(leg) {
                                        if (!routeDetails) return;
                                        routeDetails.innerHTML = '';
                                        if (!leg) {
                                                routeDetails.textContent = 'Route ready.';
                                                return;
                                        }

                                        var metrics = [];
                                        if (leg.distance && leg.distance.text) metrics.push(leg.distance.text);
                                        if (leg.duration && leg.duration.text) metrics.push(leg.duration.text);

                                        if (metrics.length) {
                                                var primary = document.createElement('div');
                                                primary.className = 'route-primary';
                                                primary.textContent = metrics.join(' • ');
                                                routeDetails.appendChild(primary);
                                        }

                                        if (leg.start_address || leg.end_address) {
                                                var secondary = document.createElement('div');
                                                secondary.className = 'route-secondary';
                                                var ends = [];
                                                if (leg.start_address) ends.push(leg.start_address);
                                                if (leg.end_address) ends.push(leg.end_address);
                                                secondary.textContent = ends.join(' → ');
                                                routeDetails.appendChild(secondary);
                                        }

                                        if (!routeDetails.innerHTML) {
                                                routeDetails.textContent = 'Route ready.';
                                        }
                                };

                                var updateProgressBar = function(percent) {
                                        if (!progressBar || !progressFill) return;
                                        var clamped = Math.max(0, Math.min(100, percent || 0));
                                        progressFill.style.width = clamped + '%';
                                        progressBar.setAttribute('aria-valuenow', Math.round(clamped));
                                };

                                var setPlayState = function(isPlaying) {
                                        if (!playToggle) return;
                                        playToggle.textContent = isPlaying ? '⏸ Pause' : '▶ Play';
                                        playToggle.setAttribute('aria-pressed', !!isPlaying);
                                        playToggle.classList.toggle('is-active', !!isPlaying);
                                };

                                var is_moving = false;
                                var px;
                                var py;
                                var onPointerDownPointerX = 0;
                                var onPointerDownPointerY = 0;

                                var hyperlapse = new Hyperlapse(pano, {
                                        lookat: lookat_point,
                                        fov: 80,
                                        millis: 50,
                                        width: window.innerWidth,
                                        height: window.innerHeight,
                                        zoom: 2,
                                        use_lookat: true,
                                        distance_between_points: 5,
                                        max_points: 100,
                                        elevation: _elevation
                                });

                                setPlayState(false);
                                updateProgressBar(0);

                                if (playToggle) {
                                        playToggle.addEventListener('click', function() {
                                                if (hyperlapse.isPlaying()) {
                                                        hyperlapse.pause();
                                                } else {
                                                        hyperlapse.play();
                                                }
                                        });
                                }

                                if (nextButton) {
                                        nextButton.addEventListener('click', function() {
                                                hyperlapse.next();
                                        });
                                }

                                if (prevButton) {
                                        prevButton.addEventListener('click', function() {
                                                hyperlapse.prev();
                                        });
                                }

                                if (loadButton) {
                                        loadButton.addEventListener('click', function() {
                                                hyperlapse.load();
                                        });
                                }

                                if (generateButton) {
                                        generateButton.addEventListener('click', function() {
                                                o.generate();
                                        });
                                }

                                if (dropPinsButton) {
                                        dropPinsButton.addEventListener('click', function() {
                                                o.drop_pins();
                                        });
                                }

                                hyperlapse.onRouteProgress = function(e) {
                                        if (!progressBar) return;
                                        var percent = e.position / e.length * 100;
                                        progressBar.setAttribute('aria-valuenow', Math.round(percent));
                                        updateProgressBar(percent);
                                        show('Building route: ' + e.position + ' of ' + e.length + ' points');
                                };

                                hyperlapse.onRouteReady = function(e) {
                                        updateProgressBar(12);
                                        show('Route ready, loading images...');
                                        setRouteDetails(e.route.legs[0]);

                                        var legs = e.route.legs[0];

                                        var a = new google.maps.Marker({
                                                position: legs.start_location,
                                                map: map
                                        });

                                        var b = new google.maps.Marker({
                                                position: legs.end_location,
                                                map: map
                                        });

                                        _route_markers.push(a);
                                        _route_markers.push(b);

                                        directions_renderer.setDirections(e.response);
                                };

                                hyperlapse.onLoadProgress = function(e) {
                                        if (!progressBar) return;
                                        var percent = e.position / e.length * 100;
                                        progressBar.setAttribute('aria-valuenow', Math.round(percent));
                                        updateProgressBar(percent);
                                        show('Loading image: ' + e.position + ' of ' + e.length);
                                };

                                hyperlapse.onError = function(e) {
                                        console.log(e);
                                        show('There was an error generating or loading the hyperlapse.');
                                };

                                hyperlapse.onLoadComplete = function() {
                                        updateProgressBar(100);
                                        show('Hyperlapse ready.');
                                        setPlayState(false);
                                        if (routeDetails) {
                                                routeDetails.textContent = 'Frames ready. Hit play or scrub the controls!';
                                        }
                                };

                                hyperlapse.onFrame = function(e) {
                                        var length = hyperlapse.length();
                                        if (length) {
                                                updateProgressBar(((e.position + 1) / length) * 100);
                                        }
                                        show(''
                                                + 'Start: ' + start_pin.getPosition().toString()
                                                + '<br>End: ' + end_pin.getPosition().toString()
                                                + '<br>Lookat: ' + pivot_pin.getPosition().toString()
                                                + '<br>Position: ' + (e.position + 1) + ' of ' + hyperlapse.length());
                                        camera_pin.setPosition(e.point.location);
                                };

                                hyperlapse.onPlay = function() {
                                        setPlayState(true);
                                };

                                hyperlapse.onPause = function() {
                                        setPlayState(false);
                                };

                                pano.addEventListener('mousedown', function(e) {
                                        e.preventDefault();

                                        is_moving = true;

                                        onPointerDownPointerX = e.clientX;
                                        onPointerDownPointerY = e.clientY;

                                        px = hyperlapse.position.x;
                                        py = hyperlapse.position.y;
                                }, false);

                                pano.addEventListener('mousemove', function(e) {
                                        e.preventDefault();
                                        var f = hyperlapse.fov() / 500;

                                        if (is_moving) {
                                                var dx = (onPointerDownPointerX - e.clientX) * f;
                                                var dy = (e.clientY - onPointerDownPointerY) * f;
                                                hyperlapse.position.x = px + dx;
                                                hyperlapse.position.y = py + dy;

                                                o.position_x = hyperlapse.position.x;
                                                o.position_y = hyperlapse.position.y;
                                        }
                                }, false);

                                pano.addEventListener('mouseup', function() {
                                        is_moving = false;

                                        hyperlapse.position.x = px;
                                }, false);

                                var gui = new dat.GUI();

                                var o = {
                                        distance_between_points: 10,
                                        max_points: 100,
                                        fov: 80,
                                        elevation: Math.floor(_elevation),
                                        tilt: 0,
                                        millis: 50,
                                        offset_x: 0,
                                        offset_y: 0,
                                        offset_z: 0,
                                        position_x: 0,
                                        position_y: 0,
                                        use_lookat: true,
                                        screen_width: window.innerWidth,
                                        screen_height: window.innerHeight,
                                        generate: function() {
                                                show('Generating route...');

                                                if (routeDetails) {
                                                        routeDetails.textContent = 'Calculating route…';
                                                }
                                                updateProgressBar(2);

                                                directions_renderer.setDirections({ routes: [] });

                                                var marker;
                                                while (_route_markers.length > 0) {
                                                        marker = _route_markers.pop();
                                                        marker.setMap(null);
                                                }

                                                var request = {
                                                        origin: start_point,
                                                        destination: end_point,
                                                        travelMode: google.maps.DirectionsTravelMode.DRIVING
                                                };

                                                directions_service.route(request, function(response, status) {
                                                        if (status === google.maps.DirectionsStatus.OK) {
                                                                hyperlapse.generate({ route: response });
                                                        } else {
                                                                console.log(status);
                                                                show('Directions request failed: ' + status);
                                                        }
                                                });
                                        },
                                        drop_pins: function() {
                                                var bounds = map.getBounds();
                                                if (!bounds) {
                                                        return;
                                                }
                                                var top_left = bounds.getNorthEast();
                                                var bot_right = bounds.getSouthWest();
                                                var hdif = Math.abs(top_left.lng() - bot_right.lng());
                                                var spacing = hdif / 4;

                                                var center = map.getCenter();
                                                var c1 = new google.maps.LatLng(center.lat(), center.lng() - spacing);
                                                var c2 = new google.maps.LatLng(center.lat(), center.lng());
                                                var c3 = new google.maps.LatLng(center.lat(), center.lng() + spacing);

                                                hyperlapse.lookat = c2;
                                                pivot_pin.setPosition(c2);

                                                snapToRoad(c1, function(result1) {
                                                        if (!result1) {
                                                                return;
                                                        }
                                                        start_pin.setPosition(result1);
                                                        start_point = result1;

                                                        snapToRoad(c3, function(result3) {
                                                                if (!result3) {
                                                                        return;
                                                                }
                                                                end_pin.setPosition(result3);
                                                                end_point = result3;
                                                                changeHash();
                                                        });
                                                });
                                        }
                                };

                                var scn = gui.addFolder('screen');
                                scn.add(o, 'screen_width', window.innerHeight).listen();
                                scn.add(o, 'screen_height', window.innerHeight).listen();

                                var parameters = gui.addFolder('parameters');

                                var distance_between_points_control = parameters.add(o, 'distance_between_points', 5, 100);
                                distance_between_points_control.onChange(function(value) {
                                        hyperlapse.setDistanceBetweenPoint(value);
                                });

                                var max_points = parameters.add(o, 'max_points', 10, 300);
                                max_points.onChange(function(value) {
                                        hyperlapse.setMaxPoints(value);
                                });

                                var fov_control = parameters.add(o, 'fov', 1, 180);
                                fov_control.onChange(function(value) {
                                        hyperlapse.setFOV(value);
                                });

                                var pitch_control = parameters.add(o, 'elevation', -1000, 1000);
                                pitch_control.onChange(function(value) {
                                        _elevation = value;
                                        hyperlapse.elevation_offset = value;
                                        changeHash();
                                });

                                var millis_control = parameters.add(o, 'millis', 10, 250);
                                millis_control.onChange(function(value) {
                                        hyperlapse.millis = value;
                                });

                                var offset_x_control = parameters.add(o, 'offset_x', -360, 360);
                                offset_x_control.onChange(function(value) {
                                        hyperlapse.offset.x = value;
                                });

                                var offset_y_control = parameters.add(o, 'offset_y', -180, 180);
                                offset_y_control.onChange(function(value) {
                                        hyperlapse.offset.y = value;
                                });

                                var offset_z_control = parameters.add(o, 'offset_z', -360, 360);
                                offset_z_control.onChange(function(value) {
                                        hyperlapse.offset.z = value;
                                });

                                var position_x_control = parameters.add(o, 'position_x', -360, 360).listen();
                                position_x_control.onChange(function(value) {
                                        hyperlapse.position.x = value;
                                });

                                var position_y_control = parameters.add(o, 'position_y', -180, 180).listen();
                                position_y_control.onChange(function(value) {
                                        hyperlapse.position.y = value;
                                });

                                var tilt_control = parameters.add(o, 'tilt', -Math.PI, Math.PI);
                                tilt_control.onChange(function(value) {
                                        hyperlapse.tilt = value;
                                });

                                var lookat_control = parameters.add(o, 'use_lookat');
                                lookat_control.onChange(function(value) {
                                        hyperlapse.use_lookat = value;
                                });

                                parameters.open();

                                var play_controls = gui.addFolder('play controls');
                                play_controls.add(hyperlapse, 'play');
                                play_controls.add(hyperlapse, 'pause');
                                play_controls.add(hyperlapse, 'next');
                                play_controls.add(hyperlapse, 'prev');
                                play_controls.open();

                                gui.add(o, 'drop_pins');
                                gui.add(o, 'generate');
                                gui.add(hyperlapse, 'load');

                                window.addEventListener('resize', function() {
                                        hyperlapse.setSize(window.innerWidth, window.innerHeight);
                                        o.screen_width = window.innerWidth;
                                        o.screen_height = window.innerHeight;
                                }, false);

                                var show_ui = true;
                                document.addEventListener('keydown', function(event) {
                                        switch (event.keyCode) {
                                                case 72: /* H */
                                                        show_ui = !show_ui;
                                                        if (controlPanel) {
                                                                controlPanel.classList.toggle('is-hidden', !show_ui);
                                                        }
                                                        break;

                                                case 190: /* > */
                                                        hyperlapse.next();
                                                        break;

                                                case 188: /* < */
                                                        hyperlapse.prev();
                                                        break;
                                        }
                                }, false);

                                o.generate();
                        }

                        if (document.readyState === 'loading') {
                                document.addEventListener('DOMContentLoaded', init);
                        } else {
                                init();
                        }
                }, function(error) {
                        function showError() {
                                var status = document.getElementById('text');
                                if (status) {
                                        status.textContent = error && error.message ? error.message : 'Unable to load the Google Maps API.';
                                }
                        }

                        if (document.readyState === 'loading') {
                                document.addEventListener('DOMContentLoaded', showError);
                        } else {
                                showError();
                        }
                });
        </script>
</head>
<body>
        <div id="pano" aria-label="Hyperlapse preview"></div>
        <section class="control-panel" id="controlPanel">
                <header class="panel-header">
                        <h1>Hyperlapse Viewer</h1>
                        <p class="panel-subtitle">Drag the pins to pick your start, pivot and end points or search for a location.</p>
                </header>
                <form id="mapForm" class="search-form" novalidate>
                        <label class="sr-only" for="address">Search for an address</label>
                        <input type="text" name="address" id="address" placeholder="Search for an address or landmark" autocomplete="off" />
                        <button type="submit" id="searchButton" class="primary-button">Search</button>
                </form>
                <div class="map-wrapper">
                        <div id="map" role="application" aria-label="Route planning map"></div>
                </div>
                <div class="control-row">
                        <button type="button" id="generateButton" class="primary-button">Generate route</button>
                        <button type="button" id="dropPinsButton" class="ghost-button">Drop pins around center</button>
                </div>
                <div class="control-row control-row--compact">
                        <button type="button" id="playToggle" class="control-button" aria-pressed="false">▶ Play</button>
                        <button type="button" id="prevButton" class="control-button" aria-label="Previous frame">⟨ Prev</button>
                        <button type="button" id="nextButton" class="control-button" aria-label="Next frame">Next ⟩</button>
                        <button type="button" id="loadButton" class="ghost-button ghost-button--inline">Reload frames</button>
                </div>
                <div class="progress" id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                        <div class="progress__fill" id="progressFill"></div>
                </div>
                <dl class="status-list">
                        <div class="status-list__item">
                                <dt>Status</dt>
                                <dd id="text">Choose start and end points to begin.</dd>
                        </div>
                        <div class="status-list__item">
                                <dt>Route details</dt>
                                <dd id="routeDetails">No route generated yet.</dd>
                        </div>
                        <div class="status-list__item">
                                <dt>Shortcuts</dt>
                                <dd>Press <kbd>H</kbd> to toggle this panel. Use <kbd>&lt;</kbd> and <kbd>&gt;</kbd> to step through frames.</dd>
                        </div>
                </dl>
        </section>
</body>
</html>
